<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸‹è½½ - huluobuo.github.io</title>
    <link rel="stylesheet" href="../styles.min.css">
    <meta name="description" content="æ–‡ä»¶ä¸‹è½½é¡µé¢">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        .icon-download::before { content: "â¬‡"; }
        .icon-check::before { content: "âœ“"; }
        .icon-error::before { content: "âš "; }
        .icon-arrow::before { content: "â†"; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/">
                <h1>huluobuo.github.io</h1>
            </a>
            <a href="https://github.com/huluobuo" target="_blank" rel="noopener noreferrer" class="tooltip" data-tooltip="è®¿é—®æˆ‘çš„GitHub">
                <img src="../img/github_logo.png" alt="GitHub" width="32" height="32">
            </a>
        </div>
    </header>

    <main class="content">
        <section class="download-section" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: var(--border-radius); padding: 3rem; text-align: center; box-shadow: var(--shadow-xl);">
            <div class="download-icon" style="margin-bottom: 2rem;">
                <span style="font-size: 4rem; color: var(--primary-color);">ğŸ“</span>
            </div>
            
            <h2 style="margin-bottom: 1.5rem; color: var(--gray-800);">å‡†å¤‡ä¸‹è½½æ–‡ä»¶</h2>
            
            <div class="countdown-container" style="margin-bottom: 2rem;">
                <div class="countdown-circle" style="width: 80px; height: 80px; border: 4px solid var(--gray-200); border-radius: 50%; margin: 0 auto 1rem; background: var(--primary-color); opacity: 0.8;"></div>
                <p id="countdown" style="font-size: 1.25rem; font-weight: 600; color: var(--gray-700);">3 ç§’åå¼€å§‹ä¸‹è½½</p>
            </div>

            <div class="download-info" style="background: var(--gray-100); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--gray-800);">ä¸‹è½½è¯´æ˜</h3>
                <ul style="text-align: left; color: var(--gray-600); line-height: 1.8;">
                    <li>æ–‡ä»¶å°†åœ¨å€’è®¡æ—¶ç»“æŸåè‡ªåŠ¨å¼€å§‹ä¸‹è½½</li>
                    <li>å¦‚æœä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹çš„ç›´æ¥ä¸‹è½½æŒ‰é’®</li>
                    <li>è¯·ç¡®ä¿æ‚¨çš„æµè§ˆå™¨å…è®¸ä¸‹è½½æ–‡ä»¶</li>
                    <li>ä¸‹è½½å®Œæˆåè¯·åŠæ—¶æŸ¥æ€ç—…æ¯’</li>
                </ul>
            </div>

            <div id="download-controls" class="hidden" style="margin-top: 2rem;">
                <p id="direct-download-tip" style="margin-bottom: 1rem; color: var(--gray-600);">ä¸‹è½½æ²¡æœ‰å¼€å§‹ï¼Ÿ</p>
                <a id="download-button" href="#" class="button" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <span class="icon-download"></span>
                    ç›´æ¥ä¸‹è½½
                </a>
            </div>

            <div id="success-message" class="message success hidden" style="margin-top: 2rem;">
                <span class="icon-check" style="margin-right: 0.5rem;"></span>
                ä¸‹è½½å·²å¼€å§‹ï¼æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ã€‚
            </div>

            <div class="back-link" style="margin-top: 2rem;">
                <a href="./" style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: var(--transition);">
                    <span class="icon-arrow"></span>
                    è¿”å›æ–‡ä»¶åˆ—è¡¨
                </a>
            </div>
        </section>
    </main>

    <script>
        class DownloadManager {
            constructor() {
                this.countdown = 3;
                this.fileLink = null;
                this.init();
            }

            init() {
                this.getFileLink();
                this.startCountdown();
                this.setupEventListeners();
            }

            getFileLink() {
                const urlParams = new URLSearchParams(window.location.search);
                this.fileLink = urlParams.get('file');
                
                if (!this.fileLink) {
                    this.showError('æœªæŒ‡å®šä¸‹è½½æ–‡ä»¶');
                    return;
                }

                // è®¾ç½®ä¸‹è½½æŒ‰é’®é“¾æ¥
                const downloadButton = document.getElementById('download-button');
                downloadButton.href = this.fileLink;
            }

            startCountdown() {
                if (!this.fileLink) return;

                const countdownElement = document.getElementById('countdown');
                const countdownCircle = document.querySelector('.countdown-circle');
                
                const timer = setInterval(() => {
                    this.countdown--;
                    countdownElement.textContent = `${this.countdown} ç§’åå¼€å§‹ä¸‹è½½`;
                    
                    if (this.countdown <= 0) {
                        clearInterval(timer);
                        this.startDownload();
                    }
                }, 1000);
            }

            startDownload() {
                // éšè—å€’è®¡æ—¶ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                document.querySelector('.countdown-container').style.display = 'none';
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('download-controls').classList.remove('hidden');
                
                // å¼€å§‹ä¸‹è½½
                try {
                    // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = this.fileLink;
                    link.download = '';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜
                    document.title = 'ä¸‹è½½ä¸­... - huluobuo.github.io';
                    
                    // æ·»åŠ ä¸‹è½½ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰
                    this.trackDownload();
                    
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    this.showError('ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•ç›´æ¥ä¸‹è½½');
                }
            }

            setupEventListeners() {
                // ç›´æ¥ä¸‹è½½æŒ‰é’®äº‹ä»¶
                document.getElementById('download-button').addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const button = e.target.closest('.button');
                    const icon = button.querySelector('span');
                    const originalText = icon.textContent;
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    icon.textContent = 'â³';
                    button.style.pointerEvents = 'none';
                    
                    // å»¶è¿Ÿä¸‹è½½ä»¥æ˜¾ç¤ºåŠ¨ç”»
                    setTimeout(() => {
                        window.open(this.fileLink, '_blank');
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        icon.textContent = originalText;
                        button.style.pointerEvents = '';
                    }, 1000);
                });

                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        if (this.countdown <= 0) {
                            document.getElementById('download-button').click();
                        }
                    }
                });
            }

            showError(message) {
                const section = document.querySelector('.download-section');
                section.innerHTML = `
                    <div class="download-icon" style="margin-bottom: 2rem;">
                        <span style="font-size: 4rem; color: var(--error-color);">âš </span>
                    </div>
                    <h2 style="margin-bottom: 1rem; color: var(--error-color);">ä¸‹è½½å‡ºé”™</h2>
                    <div class="message error" style="margin-bottom: 2rem;">
                        ${message}
                    </div>
                    <div class="back-link">
                        <a href="./" style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span class="icon-arrow"></span>
                            è¿”å›æ–‡ä»¶åˆ—è¡¨
                        </a>
                    </div>
                `;
            }

            trackDownload() {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸‹è½½ç»Ÿè®¡é€»è¾‘
                console.log(`æ–‡ä»¶ä¸‹è½½: ${this.fileLink}`);
                
                // å¯ä»¥å‘é€ç»Ÿè®¡æ•°æ®åˆ°æœåŠ¡å™¨
                // fetch('/api/track-download', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ file: this.fileLink, timestamp: Date.now() })
                // });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new DownloadManager();
        });

        // æ·»åŠ é¡µé¢ç¦»å¼€ç¡®è®¤ï¼ˆå¯é€‰ï¼‰
        window.addEventListener('beforeunload', (e) => {
            // å¦‚æœæ­£åœ¨ä¸‹è½½ï¼Œæç¤ºç”¨æˆ·
            if (document.getElementById('success-message').classList.contains('hidden') === false) {
                e.preventDefault();
                e.returnValue = 'ä¸‹è½½å¯èƒ½æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        });
    </script>
</body>
</html>