<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹åº“</title>
    <link rel="stylesheet" href="./css/music.css">
</head>
<body>
    <div class="header">
        <a href="./index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <h1>ğŸµ éŸ³ä¹åº“</h1>
    </div>

    <div class="container">
        <div class="player-container">
            <div class="now-playing">æ­£åœ¨æ’­æ”¾</div>
            <div class="current-song" id="currentSong">è¯·é€‰æ‹©ä¸€é¦–æ­Œæ›²</div>
            <audio id="audioPlayer" preload="metadata"></audio>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <div class="control-section">
                <div class="control-buttons">
                    <button class="control-btn" id="prevBtn" title="ä¸Šä¸€é¦–">â®</button>
                    <button class="control-btn play-pause" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
                    <button class="control-btn" id="nextBtn" title="ä¸‹ä¸€é¦–">â­</button>
                </div>
                <div class="volume-control">
                    <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
                    <div class="volume-slider" id="volumeSlider">
                        <div class="volume-progress" id="volumeProgress"></div>
                    </div>
                </div>
                <button class="play-mode-btn" id="playModeBtn" title="æ’­æ”¾æ¨¡å¼">ğŸ” åˆ—è¡¨å¾ªç¯</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²...">
            <span class="search-icon">ğŸ”</span>
        </div>

        <div class="stats" id="stats">å…± <span id="totalCount">0</span> é¦–æ­Œæ›²</div>

        <div id="musicList" class="music-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        let musicList = [];
        let filteredList = [];
        let currentIndex = -1;
        let playMode = 0; // 0: åˆ—è¡¨å¾ªç¯, 1: å•æ›²å¾ªç¯, 2: éšæœºæ’­æ”¾
        const playModes = ['ğŸ” åˆ—è¡¨å¾ªç¯', 'ğŸ”‚ å•æ›²å¾ªç¯', 'ğŸ”€ éšæœºæ’­æ”¾'];
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const currentSongEl = document.getElementById('currentSong');
        const searchInput = document.getElementById('searchInput');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeProgress = document.getElementById('volumeProgress');
        const volumeIcon = document.getElementById('volumeIcon');
        const playModeBtn = document.getElementById('playModeBtn');
        const statsEl = document.getElementById('stats');
        const totalCountEl = document.getElementById('totalCount');

        // åˆå§‹åŒ–éŸ³é‡
        audioPlayer.volume = 0.7;
        volumeProgress.style.width = '70%';

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getMusicPath(name) {
            return `./musics/${name}.mp3`;
        }

        function playMusic(index) {
            if (index < 0 || index >= filteredList.length) return;
            
            currentIndex = index;
            const musicName = filteredList[index];
            const musicPath = getMusicPath(musicName);
            
            audioPlayer.src = musicPath;
            currentSongEl.textContent = musicName;
            
            audioPlayer.play().catch(e => {
                console.error('æ’­æ”¾å¤±è´¥:', e);
                currentSongEl.textContent = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨';
            });
            
            updatePlayButton();
            updateMusicItems();
        }

        function updatePlayButton() {
            playPauseBtn.textContent = audioPlayer.paused ? 'â–¶' : 'â¸';
        }

        function updateMusicItems() {
            document.querySelectorAll('.music-item').forEach((item, index) => {
                if (index === currentIndex) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        function loadMusicList() {
            fetch('./api/musiclist.json')
                .then(response => response.json())
                .then(data => {
                    musicList = data;
                    filteredList = data;
                    totalCountEl.textContent = data.length;
                    renderMusicList();
                })
                .catch(error => {
                    document.getElementById('musicList').innerHTML = 
                        '<div class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    console.error('åŠ è½½éŸ³ä¹åˆ—è¡¨å¤±è´¥:', error);
                });
        }

        function renderMusicList() {
            const musicListEl = document.getElementById('musicList');
            musicListEl.innerHTML = '';

            if (filteredList.length === 0) {
                musicListEl.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</div>';
                totalCountEl.textContent = '0';
                return;
            }

            totalCountEl.textContent = filteredList.length;

            filteredList.forEach((music, index) => {
                const item = document.createElement('div');
                item.className = 'music-item';
                item.style.animationDelay = `${index * 0.03}s`;
                
                item.innerHTML = `
                    <div class="music-number">${index + 1}</div>
                    <div class="music-icon">ğŸµ</div>
                    <div class="music-info">
                        <div class="music-name">${music}</div>
                        <div class="play-indicator">æ­£åœ¨æ’­æ”¾...</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (currentIndex === index && !audioPlayer.paused) {
                        audioPlayer.pause();
                    } else {
                        playMusic(index);
                    }
                    updatePlayButton();
                });
                
                musicListEl.appendChild(item);
            });
        }

        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            filteredList = musicList.filter(music => 
                music.toLowerCase().includes(keyword)
            );
            renderMusicList();
            if (currentIndex >= 0) {
                const newIndex = filteredList.findIndex(m => 
                    musicList[currentIndex] === m
                );
                if (newIndex >= 0) {
                    currentIndex = newIndex;
                    updateMusicItems();
                }
            }
        });

        // æ’­æ”¾å™¨æ§åˆ¶
        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                if (currentIndex === -1) {
                    playMusic(0);
                } else {
                    audioPlayer.play();
                }
            } else {
                audioPlayer.pause();
            }
            updatePlayButton();
        });

        function getNextIndex() {
            if (playMode === 2) { // éšæœºæ’­æ”¾
                return Math.floor(Math.random() * filteredList.length);
            } else if (playMode === 1) { // å•æ›²å¾ªç¯
                return currentIndex;
            } else { // åˆ—è¡¨å¾ªç¯
                return (currentIndex + 1) % filteredList.length;
            }
        }

        function getPrevIndex() {
            if (playMode === 2) { // éšæœºæ’­æ”¾
                return Math.floor(Math.random() * filteredList.length);
            } else if (playMode === 1) { // å•æ›²å¾ªç¯
                return currentIndex;
            } else { // åˆ—è¡¨å¾ªç¯
                return currentIndex > 0 ? currentIndex - 1 : filteredList.length - 1;
            }
        }

        prevBtn.addEventListener('click', () => {
            const prevIndex = getPrevIndex();
            playMusic(prevIndex);
        });

        nextBtn.addEventListener('click', () => {
            const nextIndex = getNextIndex();
            playMusic(nextIndex);
        });

        // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
        playModeBtn.addEventListener('click', () => {
            playMode = (playMode + 1) % 3;
            playModeBtn.textContent = playModes[playMode];
        });

        // éŸ³é‡æ§åˆ¶
        volumeSlider.addEventListener('click', (e) => {
            const rect = volumeSlider.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audioPlayer.volume = percent;
            volumeProgress.style.width = (percent * 100) + '%';
            updateVolumeIcon(percent);
        });

        volumeIcon.addEventListener('click', () => {
            if (audioPlayer.volume > 0) {
                audioPlayer.volume = 0;
                volumeProgress.style.width = '0%';
                volumeIcon.textContent = 'ğŸ”‡';
            } else {
                audioPlayer.volume = 0.7;
                volumeProgress.style.width = '70%';
                volumeIcon.textContent = 'ğŸ”Š';
            }
        });

        function updateVolumeIcon(volume) {
            if (volume === 0) {
                volumeIcon.textContent = 'ğŸ”‡';
            } else if (volume < 0.5) {
                volumeIcon.textContent = 'ğŸ”‰';
            } else {
                volumeIcon.textContent = 'ğŸ”Š';
            }
        }

        // è¿›åº¦æ¡
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progress.style.width = percent + '%';
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            }
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            if (playMode === 1) { // å•æ›²å¾ªç¯
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                const nextIndex = getNextIndex();
                playMusic(nextIndex);
            }
        });

        progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audioPlayer.currentTime = percent * audioPlayer.duration;
        });

        audioPlayer.addEventListener('play', updatePlayButton);
        audioPlayer.addEventListener('pause', updatePlayButton);

        loadMusicList();
    </script>
</body>
</html>
