<!DOCTYPE html>
<html lang="zh-CN">
<!--
    éŸ³ä¹æ’­æ”¾å™¨é¡µé¢
    ä¸»è¦åŠŸèƒ½ï¼š
    - éŸ³ä¹åˆ—è¡¨å±•ç¤ºå’Œæœç´¢
    - éŸ³ä¹æ’­æ”¾æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœã€ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–ï¼‰
    - éŸ³é‡æ§åˆ¶
    - æ’­æ”¾æ¨¡å¼åˆ‡æ¢ï¼ˆåˆ—è¡¨å¾ªç¯ã€å•æ›²å¾ªç¯ã€éšæœºæ’­æ”¾ï¼‰
    - è¿›åº¦æ¡æ˜¾ç¤ºå’Œæ‰‹åŠ¨è°ƒæ•´
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æ’­æ”¾å™¨ - huluobuo</title>
    <link rel="stylesheet" href="./assets/css/music.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- èƒŒæ™¯å›¾ç‰‡åŠ è½½å™¨ -->
    <div id="backgroundLoader" class="background-loader">
        <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
    <!-- GitHubé£æ ¼å¤´éƒ¨ -->
    <header class="github-header">
        <div class="header-content">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
            <h1>éŸ³ä¹æ’­æ”¾å™¨</h1>
        </div>
    </header>
    
    <!-- GitHubé£æ ¼ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="github-main">
        <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
        <section class="player-section">
            <div class="now-playing">æ­£åœ¨æ’­æ”¾</div>
            <div class="current-song" id="currentSong">é€‰æ‹©ä¸€é¦–æ­Œæ›²å¼€å§‹æ’­æ”¾</div>
            <audio id="audioPlayer" preload="metadata"></audio>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
            
            <div class="control-section">
                <div class="control-buttons">
                    <button class="control-btn" id="prevBtn" title="ä¸Šä¸€é¦–">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="nextBtn" title="ä¸‹ä¸€é¦–">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="volume-control">
                    <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
                    <div class="volume-slider" id="volumeSlider">
                        <div class="volume-progress" id="volumeProgress"></div>
                    </div>
                </div>
                
                <button class="play-mode-btn" id="playModeBtn" title="æ’­æ”¾æ¨¡å¼">
                    <i class="fas fa-random"></i> éšæœºæ’­æ”¾
                </button>
            </div>
        </section>
        
        <!-- æœç´¢æ¡† -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²...">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats" id="stats">å…± <span id="totalCount">0</span> é¦–æ­Œæ›²</div>
        
        <!-- éŸ³ä¹åˆ—è¡¨ -->
        <section class="music-section">
            <div class="music-list" id="musicList">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                </div>
            </div>
        </section>
    </main>

    <script>
        let musicList = [];
        let filteredList = [];
        let currentIndex = -1;
        let playMode = 0; // 0: åˆ—è¡¨å¾ªç¯, 1: å•æ›²å¾ªç¯, 2: éšæœºæ’­æ”¾
        const playModes = ['ğŸ” åˆ—è¡¨å¾ªç¯', 'ğŸ”‚ å•æ›²å¾ªç¯', 'ğŸ”€ éšæœºæ’­æ”¾'];
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const currentSongEl = document.getElementById('currentSong');
        const searchInput = document.getElementById('searchInput');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeProgress = document.getElementById('volumeProgress');
        const volumeIcon = document.getElementById('volumeIcon');
        const playModeBtn = document.getElementById('playModeBtn');
        const statsEl = document.getElementById('stats');
        const totalCountEl = document.getElementById('totalCount');
        
        // åˆå§‹åŒ–éŸ³é‡
        audioPlayer.volume = 0.7;
        volumeProgress.style.width = '70%';

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // è·å–éŸ³ä¹æ–‡ä»¶è·¯å¾„
        function getMusicPath(musicName) {
            return `./musics/${musicName}.mp3`;
        }

        // ä¸‹è½½éŸ³ä¹
        function downloadMusic(musicUrl, musicName) {
            // æ˜¾ç¤ºä¸‹è½½æç¤º
            showDownloadToast('å¼€å§‹ä¸‹è½½: ' + musicName);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = musicUrl;
            a.download = musicName + '.mp3';
            
            // æ·»åŠ ä¸‹è½½å®Œæˆäº‹ä»¶
            a.addEventListener('click', function() {
                setTimeout(() => {
                    showDownloadToast('ä¸‹è½½å®Œæˆ: ' + musicName, 'success');
                }, 1000);
            });
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // æ˜¾ç¤ºä¸‹è½½æç¤º
        function showDownloadToast(message, type = 'info') {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `download-toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function playMusic(index) {
            if (index < 0 || index >= filteredList.length) return;
            
            currentIndex = index;
            const musicName = filteredList[index];
            const musicPath = getMusicPath(musicName);
            
            audioPlayer.src = musicPath;
            currentSongEl.textContent = musicName;
            
            audioPlayer.play().catch(e => {
                console.error('æ’­æ”¾å¤±è´¥:', e);
                currentSongEl.textContent = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨';
            });
            
            updatePlayButton();
            updateMusicItems();
        }

        function updatePlayButton() {
            playPauseBtn.textContent = audioPlayer.paused ? 'â–¶' : 'â¸';
        }

        function updateMusicItems() {
            document.querySelectorAll('.music-item').forEach((item, index) => {
                if (index === currentIndex) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        function loadMusicList() {
            fetch('./api/musiclist.json')
                .then(response => response.json())
                .then(data => {
                    musicList = data;
                    filteredList = data;
                    totalCountEl.textContent = data.length;
                    renderMusicList();
                })
                .catch(error => {
                    document.getElementById('musicList').innerHTML = 
                        '<div class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    console.error('åŠ è½½éŸ³ä¹åˆ—è¡¨å¤±è´¥:', error);
                });
        }

        function renderMusicList() {
            const musicListEl = document.getElementById('musicList');
            musicListEl.innerHTML = '';

            if (filteredList.length === 0) {
                musicListEl.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²</div>';
                totalCountEl.textContent = '0';
                return;
            }

            totalCountEl.textContent = filteredList.length;

            filteredList.forEach((music, index) => {
                const item = document.createElement('div');
                item.className = 'music-item';
                item.style.animationDelay = `${index * 0.03}s`;
                
                item.innerHTML = `
                    <div class="music-number">${index + 1}</div>
                    <div class="music-icon">ğŸµ</div>
                    <div class="music-info">
                        <div class="music-name">${music}</div>
                        <div class="play-indicator">æ­£åœ¨æ’­æ”¾...</div>
                    </div>
                    <div class="music-actions">
                        <button class="action-btn download-btn" onclick="downloadMusic('${getMusicPath(music)}', '${music}')" aria-label="ä¸‹è½½æ­Œæ›² ${music}">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (currentIndex === index && !audioPlayer.paused) {
                        audioPlayer.pause();
                    } else {
                        playMusic(index);
                    }
                    updatePlayButton();
                });
                
                musicListEl.appendChild(item);
            });
        }

        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            filteredList = musicList.filter(music => 
                music.toLowerCase().includes(keyword)
            );
            renderMusicList();
            if (currentIndex >= 0) {
                const newIndex = filteredList.findIndex(m => 
                    musicList[currentIndex] === m
                );
                if (newIndex >= 0) {
                    currentIndex = newIndex;
                    updateMusicItems();
                }
            }
        });

        // æ’­æ”¾å™¨æ§åˆ¶
        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                if (currentIndex === -1) {
                    playMusic(0);
                } else {
                    audioPlayer.play();
                }
            } else {
                audioPlayer.pause();
            }
            updatePlayButton();
        });

        function getNextIndex() {
            if (playMode === 2) { // éšæœºæ’­æ”¾
                return Math.floor(Math.random() * filteredList.length);
            } else if (playMode === 1) { // å•æ›²å¾ªç¯
                return currentIndex;
            } else { // åˆ—è¡¨å¾ªç¯
                return (currentIndex + 1) % filteredList.length;
            }
        }

        function getPrevIndex() {
            if (playMode === 2) { // éšæœºæ’­æ”¾
                return Math.floor(Math.random() * filteredList.length);
            } else if (playMode === 1) { // å•æ›²å¾ªç¯
                return currentIndex;
            } else { // åˆ—è¡¨å¾ªç¯
                return currentIndex > 0 ? currentIndex - 1 : filteredList.length - 1;
            }
        }

        prevBtn.addEventListener('click', () => {
            const prevIndex = getPrevIndex();
            playMusic(prevIndex);
        });

        nextBtn.addEventListener('click', () => {
            const nextIndex = getNextIndex();
            playMusic(nextIndex);
        });

        // æ’­æ”¾æ¨¡å¼åˆ‡æ¢
        playModeBtn.addEventListener('click', () => {
            playMode = (playMode + 1) % 3;
            playModeBtn.textContent = playModes[playMode];
        });

        // éŸ³é‡æ§åˆ¶
        let isVolumeDragging = false;
        
        volumeSlider.addEventListener('mousedown', (e) => {
            isVolumeDragging = true;
            volumeSlider.classList.add('dragging');
            volumeProgress.classList.add('dragging');
            updateVolume(e);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isVolumeDragging) {
                updateVolume(e);
            }
        });
        
        document.addEventListener('mouseup', () => {
            isVolumeDragging = false;
            volumeSlider.classList.remove('dragging');
            volumeProgress.classList.remove('dragging');
        });
        
        volumeSlider.addEventListener('click', (e) => {
            updateVolume(e);
        });
        
        function updateVolume(e) {
            const rect = volumeSlider.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audioPlayer.volume = percent;
            volumeProgress.style.width = (percent * 100) + '%';
            updateVolumeIcon(percent);
        }

        volumeIcon.addEventListener('click', () => {
            if (audioPlayer.volume > 0) {
                audioPlayer.volume = 0;
                volumeProgress.style.width = '0%';
                volumeIcon.textContent = 'ğŸ”‡';
            } else {
                audioPlayer.volume = 0.7;
                volumeProgress.style.width = '70%';
                volumeIcon.textContent = 'ğŸ”Š';
            }
        });

        function updateVolumeIcon(volume) {
            if (volume === 0) {
                volumeIcon.textContent = 'ğŸ”‡';
            } else if (volume < 0.5) {
                volumeIcon.textContent = 'ğŸ”‰';
            } else {
                volumeIcon.textContent = 'ğŸ”Š';
            }
        }

        // è¿›åº¦æ¡
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progress.style.width = percent + '%';
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            }
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            if (playMode === 1) { // å•æ›²å¾ªç¯
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                const nextIndex = getNextIndex();
                playMusic(nextIndex);
            }
        });

        // è¿›åº¦æ¡æ‹–æ‹½åŠŸèƒ½
        let isProgressDragging = false;
        
        progressBar.addEventListener('mousedown', (e) => {
            isProgressDragging = true;
            progressBar.classList.add('dragging');
            progress.classList.add('dragging');
            updateProgress(e);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isProgressDragging) {
                updateProgress(e);
            }
        });
        
        document.addEventListener('mouseup', () => {
            isProgressDragging = false;
            progressBar.classList.remove('dragging');
            progress.classList.remove('dragging');
        });
        
        progressBar.addEventListener('click', (e) => {
            updateProgress(e);
        });
        
        function updateProgress(e) {
            const rect = progressBar.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            const newTime = percent * audioPlayer.duration;
            
            // è®¾ç½®éŸ³é¢‘æ’­æ”¾æ—¶é—´
            audioPlayer.currentTime = newTime;
            
            // æ‰‹åŠ¨æ›´æ–°è¿›åº¦æ¡è§†è§‰æ•ˆæœ
            progress.style.width = (percent * 100) + '%';
            currentTimeEl.textContent = formatTime(newTime);
        }

        audioPlayer.addEventListener('play', updatePlayButton);
        audioPlayer.addEventListener('pause', updatePlayButton);

        loadMusicList();
    </script>
    
    <script src="./assets/js/effects.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–èƒŒæ™¯åŠ è½½
        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ–å›¾ç‰‡åŠ è½½å™¨ï¼Œä¸ºéŸ³ä¹é¡µé¢æ·»åŠ èƒŒæ™¯
            const imageLoader = new ImageLoader('./img/èƒŒæ™¯.png');
            await imageLoader.loadImages();
        });
    </script>
</body>
</html>
